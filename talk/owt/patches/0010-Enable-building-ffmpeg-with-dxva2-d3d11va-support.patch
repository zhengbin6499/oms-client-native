From 8b5ef16e6a963d93a6345377b235049ac911e943 Mon Sep 17 00:00:00 2001
From: Qiu Jianlin <jianlin.qiu@intel.com>
Date: Mon, 20 Apr 2020 19:53:01 +0800
Subject: [PATCH] Enable building ffmpeg with dxva2 d3d11va support

---
 chromium/config/Chrome/win-msvc/x64/config.h |  6 +++---
 chromium/config/Chrome/win/x64/config.h      |  6 +++---
 chromium/config/Chromium/win/x64/config.h    |  6 +++---
 ffmpeg_generated.gni                         | 11 +++++++++++
 4 files changed, 20 insertions(+), 9 deletions(-)

diff --git a/chromium/config/Chrome/win-msvc/x64/config.h b/chromium/config/Chrome/win-msvc/x64/config.h
index aabf43f10b..c69bd6b9c2 100644
--- a/chromium/config/Chrome/win-msvc/x64/config.h
+++ b/chromium/config/Chrome/win-msvc/x64/config.h
@@ -1400,9 +1400,9 @@
 #define CONFIG_H264_VAAPI_HWACCEL 0
 #define CONFIG_H264_VDPAU_HWACCEL 0
 #define CONFIG_H264_VIDEOTOOLBOX_HWACCEL 0
-#define CONFIG_HEVC_D3D11VA_HWACCEL 0
-#define CONFIG_HEVC_D3D11VA2_HWACCEL 0
-#define CONFIG_HEVC_DXVA2_HWACCEL 0
+#define CONFIG_HEVC_D3D11VA_HWACCEL 1
+#define CONFIG_HEVC_D3D11VA2_HWACCEL 1
+#define CONFIG_HEVC_DXVA2_HWACCEL 1
 #define CONFIG_HEVC_NVDEC_HWACCEL 0
 #define CONFIG_HEVC_VAAPI_HWACCEL 0
 #define CONFIG_HEVC_VDPAU_HWACCEL 0
diff --git a/chromium/config/Chrome/win/x64/config.h b/chromium/config/Chrome/win/x64/config.h
index 5a83c598a9..69b46f4d53 100644
--- a/chromium/config/Chrome/win/x64/config.h
+++ b/chromium/config/Chrome/win/x64/config.h
@@ -1400,9 +1400,9 @@
 #define CONFIG_H264_VAAPI_HWACCEL 0
 #define CONFIG_H264_VDPAU_HWACCEL 0
 #define CONFIG_H264_VIDEOTOOLBOX_HWACCEL 0
-#define CONFIG_HEVC_D3D11VA_HWACCEL 0
-#define CONFIG_HEVC_D3D11VA2_HWACCEL 0
-#define CONFIG_HEVC_DXVA2_HWACCEL 0
+#define CONFIG_HEVC_D3D11VA_HWACCEL 1
+#define CONFIG_HEVC_D3D11VA2_HWACCEL 1
+#define CONFIG_HEVC_DXVA2_HWACCEL 1
 #define CONFIG_HEVC_NVDEC_HWACCEL 0
 #define CONFIG_HEVC_VAAPI_HWACCEL 0
 #define CONFIG_HEVC_VDPAU_HWACCEL 0
diff --git a/chromium/config/Chromium/win/x64/config.h b/chromium/config/Chromium/win/x64/config.h
index 6b847a9b68..0e520955e0 100644
--- a/chromium/config/Chromium/win/x64/config.h
+++ b/chromium/config/Chromium/win/x64/config.h
@@ -1400,9 +1400,9 @@
 #define CONFIG_H264_VAAPI_HWACCEL 0
 #define CONFIG_H264_VDPAU_HWACCEL 0
 #define CONFIG_H264_VIDEOTOOLBOX_HWACCEL 0
-#define CONFIG_HEVC_D3D11VA_HWACCEL 0
-#define CONFIG_HEVC_D3D11VA2_HWACCEL 0
-#define CONFIG_HEVC_DXVA2_HWACCEL 0
+#define CONFIG_HEVC_D3D11VA_HWACCEL 1
+#define CONFIG_HEVC_D3D11VA2_HWACCEL 1
+#define CONFIG_HEVC_DXVA2_HWACCEL 1
 #define CONFIG_HEVC_NVDEC_HWACCEL 0
 #define CONFIG_HEVC_VAAPI_HWACCEL 0
 #define CONFIG_HEVC_VDPAU_HWACCEL 0
diff --git a/ffmpeg_generated.gni b/ffmpeg_generated.gni
index 610a9aaaeb..a342aab2ba 100644
--- a/ffmpeg_generated.gni
+++ b/ffmpeg_generated.gni
@@ -244,6 +244,16 @@ if ((is_mac && ffmpeg_branding == "Chrome") || (is_win && ffmpeg_branding == "Ch
     "libavcodec/h264idct.c",
     "libavcodec/h264qpel.c",
     "libavcodec/startcode.c",
+    "libavcodec/hevc_cabac.c",
+    "libavcodec/hevc_data.c",
+    "libavcodec/hevc_parse.c",
+    "libavcodec/hevc_parser.c",
+    "libavcodec/hevc_ps.c",
+    "libavcodec/hevc_refs.c",
+    "libavcodec/hevc_sei.c",
+    "libavcodec/hevcdec.c",
+    "libavcodec/hevcdsp.c",
+    "libavcodec/hevcpred.c",
   ]
 }
 
@@ -251,6 +261,7 @@ if (is_win && current_cpu == "x64" && ffmpeg_branding == "Chrome") {
   ffmpeg_c_sources += [
     "libavcodec/dxva2.c",
     "libavcodec/dxva2_h264.c",
+    "libavcodec/dxva2_hevc.c",
     "libavutil/hwcontext_d3d11va.c",
     "libavutil/hwcontext_dxva2.c",
   ]
-- 
2.24.1.windows.2

